# nginx/tasks/source_install

- include: modules

## For Debian Nodes
- name: source_install | DEBIAN | download nginx source
  get_url:
      url: "http://nginx.org/download/nginx-{{ nginx_version }}.tar.gz"
      dest: "/tmp/nginx-{{ nginx_version }}.tar.gz"
  sudo_user: "{{ nginx_user }}"
  when: ansible_os_family == 'Debian'

- name: source_install | DEBIAN | unpack Nginx source
  command: tar -xvzf /tmp/nginx-{{nginx_version}}.tar.gz chdir=/tmp creates=/tmp/nginx-{{nginx_version}}/README
  when: ansible_os_family == 'Debian'

- name: source_install | DEBIAN | compile Nginx source
  shell: >
    cd /tmp/nginx-{{nginx_version}} &&
    ./configure {{nginx_source_configure_flags}} &&
    make &&
    make install
  when: ansible_os_family == 'Debian'

- name: source_install | DEBIAN | Update the symbolic link to the nginx install
  file:
    path: /usr/local/nginx/default
    src: "{{nginx_source_prefix}}"
    state: link
    force: yes
  when: ansible_os_family == 'Debian'

- name: source_install | DEBIAN | Install the upstart init script
  template:
    src: nginx.init.j2
    dest: /etc/init.d/nginx
    owner: "{{ nginx_user }}"
    group: "{{ nginx_group }}"
    mode: 0755
  notify:
    - restart nginx
  when: ansible_os_family == 'Debian'

- name: source_install | DEBIAN | Register Nginx as a service
  service:
    name: nginx
    enabled: yes
  when: ansible_os_family == 'Debian'
